<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>파일 확장자 차단</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<h1>파일 확장자 차단</h1>

<h2>고정 확장자</h2>
<div id="fixed-list"></div>

<h2>커스텀 확장자</h2>
<input type="text" id="custom-input" placeholder="확장자 입력 (20자 이내)" maxlength="20">
<button id="add-custom">추가</button>
<div id="custom-list"></div>

<h2>파일 업로드</h2>
<input type="file" id="file-input">
<button id="upload-btn">업로드</button>

<script>
    function loadFixed() {
      $.get("/api/fixed", function(data) {
        $("#fixed-list").empty();
        data.forEach(function(item) {
          const chk = $("<input type='checkbox'>").prop("checked", item.checked);
          chk.change(() => {
            $.ajax({
              url: "/api/fixed",
              type: "PATCH",
              contentType: "application/json",
              data: JSON.stringify({name: item.name, checked: chk.is(":checked")})
            });
          });
          $("#fixed-list").append($("<div>").append(chk).append(" " + item.name));
        });
      });
    }

    function loadCustom() {
      $.get("/api/custom", function(data) {
        $("#custom-list").empty();
        data.forEach(function(item) {
          const del = $("<button>X</button>").click(() => {
            $.ajax({ url: "/api/custom/" + item.id, type: "DELETE", success: loadCustom });
          });
          $("#custom-list").append($("<div>").append(item.name + " ").append(del));
        });
      });
    }

    $("#add-custom").click(() => {
      const name = $("#custom-input").val();

      if (name.length > 20) {
        alert("20자 이내로 입력해주세요.");
        return;
      } //20자 이내 한번 더 체크

      $.ajax({
        url: "/api/custom",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({name}),
        success: (msg) => {
          if (msg === "success") {
            $("#custom-input").val("");
            loadCustom();
          } else {
            alert(msg); // 중복 또는 200개 초과 했을경우 alert
          }
        }
      });
    });

    $("#upload-btn").click(() => {
        const f = $("#file-input")[0].files[0];
        if (!f) { alert("파일을 선택하세요"); return; }

        const fd = new FormData();
        fd.append("file", f);

        $.ajax({
          url: "/api/upload",
          type: "POST",
          data: fd,
          processData: false,
          contentType: false,
          success: (msg) => {
            if (msg === "ok") alert("업로드 성공");
            else alert("차단되었습니다: " + msg);
          },
          error: (xhr) => {
            alert("업로드 실패: " + xhr.responseText);
          }
        });
      });

    $(function() {
      loadFixed();
      loadCustom();
    });
</script>
</body>
</html>
